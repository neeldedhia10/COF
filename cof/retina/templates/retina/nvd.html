<!--
# Copyrights 2020,  Sankara Netralaya & BITS Pilani,
# Contact: sundaresan.raman@pilani.bits-pilani.ac.in
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- loads the path to your staticfiles -->
    {%  load static  %}
<style>
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 25px;
            margin: 4px 2px;
            cursor: pointer;
        }

        .select-style {
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 25px;
            color: white;
            padding: 15px 32px;
            text-align: center;
            overflow: hidden;
            background-color: #4CAF50;
        }

        .select-style select {
            padding: 5px 8px;
            width: 250%;
            border: none;
            box-shadow: none;
            background: transparent;
            background-image: none;
        }

        .select-style select:focus {
            outline: none;
        }

    </style>

    <!--{{pid_imgfn}} -->
    <script src = "/static/jquery.min.js">
    </script>
    <script>
        var pid_imgfn = "{% static pid_imgfn %}";
        var patient_id = "{{ patient_id }}"
        var is_back = "{{ is_back }}";
        var my_x = "{{ my_x }}";
        var my_y = "{{ my_y }}";
        var my_r = "{{ my_r }}";

    </script>

</head>

<body onload="draw();">

<h1> Patient Id: <strong> {{ patient_id }}  </strong> </h1>
<h1><p id = "nvd_text">Please Choose Neo-Vascularization Spots on Disc by clicking on the image: </p></h1>
    {% if patient_id  %}
            <canvas id="imgCanvas" width="1016" height="1016"  onclick="canvasClick()" style="border:1px solid #000000;"></canvas>

        <form id="rhform"   action="{% url  'retina:sh' %}" method="post"  >
            {% csrf_token %}

            <div id="hidethis" class = mydiv>
                <!--<label for="my_x" >X: </label>-->
                <input type="hidden"  id="is_back" name="is_back" value = "0">
                <!--<label for="my_x" >X: </label>-->
            <input type="hidden"  id="my_x" name="my_x" >
                <!-- <label for="my_y" >Y: </label> -->
            <input type="hidden" id="my_y" name="my_y" >
                    <!-- <label for="my_r" >R: </label> -->
            <input type="hidden" id="my_r" name="my_r" >

                <!--<label for="my_pidjs" >PidJs</label>-->
                <input type="hidden" id="my_pidjs" name="pid_imgfn">
                <!--<label for="my_patientid" >PatientId</label>-->
                <input type="hidden" id="my_patientid" name="patient_id"> <br><br>
            </div>

            <input type="button"   class="button" value = "Reset All" onclick = "resetClick()" id="resetButton" >
            <input type="button"   class="button" value = "Undo" onclick = "undoClick()" id="undoButton" >
            <input type="submit"   class="button" value = "Save" id="submitButton" >
            <select id="rad" name="rad" class = "select-style" onchange = "changeRad()" >
                    <option value="Single">Single</option>
                    <option value="Small">Small</option>
                    <option value="Medium">Medium</option>
                    <option value="Large">Large</option>
                </select>

        </form>

        <form id="nvdform_b" action="{% url  'retina:nve' %}"  method="post"  >
            {% csrf_token %}
            <div id="hidethis_b" class = mydiv>
                <!--<label for="my_x" >X: </label>-->
                <input type="hidden"  id="is_back" name="is_back" value = "1">
                <input type="hidden"  id="my_x_b" name="my_x_b" >
                <!--<label for="my_y" >Y: </label>-->
                <input type="hidden" id="my_y_b" name="my_y_b" >
                 <!--<label for="my_r" >R: </label>-->
                <input type="hidden" id="my_r_b" name="my_r_b" >

                <!--<label for="my_pidjs" >PidJs</label>-->
                <input type="hidden" id="my_pidjs_b" name="pid_imgfn_b">
                <!--<label for="my_patientid" >PatientId</label>-->
                <input type="hidden" id="my_patientid_b" name="patient_id"> <br><br>
            </div>
            <input type="submit"   class="button" value = "Go Back" id="backButton" >

        </form>

    {% else  %}
        <h2> There are no more patients/images!</h2>
    {% endif  %}
     <script>
        var canvas = document.getElementById("imgCanvas");
        var context = canvas.getContext("2d");
        var img_buffer = document.createElement('img');
        var currRad = 3; // Single lesion select is the default
        document.getElementById("my_pidjs").value = pid_imgfn;
        document.getElementById("my_patientid").value = patient_id;
        document.getElementById("my_pidjs_b").value = pid_imgfn;
        document.getElementById("my_patientid_b").value = patient_id;

        function draw() {
            img_buffer.onload = function() {
                //img_buffer.width = img_buffer.width/4;
                //img_buffer.height = img_buffer.height/4;
                imgWidth = img_buffer.width;
                imgHeight = img_buffer.height;
                canvas.width = imgWidth;
                canvas.height = imgHeight;
                context.drawImage(img_buffer, 0, 0, imgWidth, imgHeight);
                // Check if this page is coming from Go Back button press, (check prev_x, prev_y)
                // if(is_back == "1") {
                   if(1) {
                    document.getElementById("my_x").value = my_x;
                    document.getElementById("my_y").value = my_y;
                    document.getElementById("my_r").value = my_r;
                    document.getElementById("my_pidjs").value = pid_imgfn;
                    document.getElementById("my_patientid").value = patient_id;
                    document.getElementById("my_x_b").value = my_x;
                    document.getElementById("my_y_b").value = my_y;
                    document.getElementById("my_r_b").value = my_r;
                    document.getElementById("my_pidjs_b").value = pid_imgfn;
                    document.getElementById("my_patientid_b").value = patient_id;
                    //Render previously entered points
                    var xv =  document.getElementById("my_x").value;
                    var yv =  document.getElementById("my_y").value;
                    var rv =  document.getElementById("my_r").value;

                    var xv_arr = xv.split("#");
                    var yv_arr = yv.split("#");
                    var rv_arr = rv.split("#");

                    var mylen = xv_arr.length;
                    if(mylen == 1)
                    {
                        context.drawImage(img_buffer, 0, 0, img_buffer.width, img_buffer.height);
                        document.getElementById("my_x").value = "";
                        document.getElementById("my_y").value = "";
                        document.getElementById("my_r").value = "";

                        document.getElementById("my_x_b").value = "";
                        document.getElementById("my_y_b").value = "";
                        document.getElementById("my_r_b").value = "";

                    }
                    else if(mylen > 1) {
                        context.drawImage(img_buffer, 0, 0, img_buffer.width, img_buffer.height);
                        document.getElementById("my_x").value = xv_arr[0] + "#";
                        document.getElementById("my_y").value = yv_arr[0] + "#";
                        document.getElementById("my_r").value = rv_arr[0] + "#";
                        document.getElementById("my_x_b").value = xv_arr[0] + "#";
                        document.getElementById("my_y_b").value = yv_arr[0] + "#";
                        document.getElementById("my_r_b").value = rv_arr[0] + "#";
                        var i;
                        drawCoordAxis(xv_arr[0], yv_arr[0], rv_arr[0]);
                        for (i=1;i < xv_arr.length-1; i++) {
                            drawCoordAxis(xv_arr[i], yv_arr[i], rv_arr[i]);
                            document.getElementById("my_x").value = document.getElementById("my_x").value + xv_arr[i] + "#";
                            document.getElementById("my_y").value = document.getElementById("my_y").value + yv_arr[i] + "#";
                            document.getElementById("my_r").value = document.getElementById("my_r").value + rv_arr[i] + "#";

                            document.getElementById("my_x_b").value = document.getElementById("my_x_b").value + xv_arr[i] + "#";
                            document.getElementById("my_y_b").value = document.getElementById("my_y_b").value + yv_arr[i] + "#";
                            document.getElementById("my_r_b").value = document.getElementById("my_r_b").value + rv_arr[i] + "#";


                        }
                    }
                }
            };
            img_buffer.src = pid_imgfn;
        }


        // Mouse Position
        canvas.addEventListener("click", function (evt) {

         var mousePos = getMousePos(canvas, evt);
         x = Math.round(mousePos.x).toString();
         y = Math.round(mousePos.y).toString();
         r = Math.round(currRad).toString();
         document.getElementById("my_x").value = document.getElementById("my_x").value +  Math.round(mousePos.x).toString() + '#';
         document.getElementById("my_y").value = document.getElementById("my_y").value +  Math.round(mousePos.y).toString() + '#';
         document.getElementById("my_r").value = document.getElementById("my_r").value +  Math.round(currRad).toString() + '#';

         document.getElementById("my_pidjs").value = pid_imgfn;
         document.getElementById("my_patientid").value = patient_id;
         document.getElementById("my_x_b").value = document.getElementById("my_x_b").value +  Math.round(mousePos.x).toString() + '#';
         document.getElementById("my_y_b").value = document.getElementById("my_y_b").value +  Math.round(mousePos.y).toString() + '#';
         document.getElementById("my_r_b").value = document.getElementById("my_r_b").value +  Math.round(currRad).toString() + '#';

         document.getElementById("my_pidjs_b").value = pid_imgfn;
         document.getElementById("my_patientid_b").value = patient_id;

         drawCoordAxis(x,y, currRad);
         //currRad = 3 ; // Revert back to small dots
        }, false);

        //Get Mouse Position
        function getMousePos(canvas, evt) {
            var rect = canvas.getBoundingClientRect();
            return {
                        x: evt.clientX - rect.left,
                        y: evt.clientY - rect.top
                    };
        }

        function drawCoordAxis(x,y, r){
            var pointSize = r; // Change according to the size of the point.
            var ctx = context;
            ctx.fillStyle = "#ff2626"; // Red color
            if(pointSize > 3)
                ctx.globalAlpha = 0.4;
            ctx.beginPath(); //Start path
            // Draw a point using the arc function of the canvas with a point structure.
            ctx.arc(x, y, pointSize, 0, Math.PI * 2, true);
            ctx.fill(); // Close the path and fill.
            ctx.globalAlpha = 1.0;
        }
        function canvasClick(){


        }
        function changeRad(){
          if (document.getElementById("rad").value == "Single")
            currRad = 3;
          else if (document.getElementById("rad").value == "Small")
            currRad = 100;
          else if (document.getElementById("rad").value == "Medium")
            currRad = 150;
          else if (document.getElementById("rad").value == "Large")
            currRad = 200;
          else
            currRad = 3;
        }


        function resetClick() {
            document.getElementById("my_x").value = "" ;
            document.getElementById("my_y").value = "" ;
            document.getElementById("my_r").value = "" ;

            document.getElementById("my_x_b").value = "" ;
            document.getElementById("my_y_b").value = "" ;
            document.getElementById("my_r_b").value = "" ;

            context.drawImage(img_buffer, 0, 0, img_buffer.width, img_buffer.height);
        }
        function undoClick() {
            var xv =  document.getElementById("my_x").value;
            var yv =  document.getElementById("my_y").value;
            var rv =  document.getElementById("my_r").value;

            var xv_arr = xv.split("#");
            var yv_arr = yv.split("#");
            var rv_arr = rv.split("#");

            var mylen = xv_arr.length;
            if(mylen == 2)
            {
                context.drawImage(img_buffer, 0, 0, img_buffer.width, img_buffer.height);
                document.getElementById("my_x").value = "";
                document.getElementById("my_y").value = "";
                document.getElementById("my_r").value = "";

                document.getElementById("my_x_b").value = "";
                document.getElementById("my_y_b").value = "";
                document.getElementById("my_r_b").value = "";

            }
            else if(mylen > 2) {
                context.drawImage(img_buffer, 0, 0, img_buffer.width, img_buffer.height);
                document.getElementById("my_x").value = xv_arr[0] + "#";
                document.getElementById("my_y").value = yv_arr[0] + "#";
                document.getElementById("my_r").value = rv_arr[0] + "#";

                document.getElementById("my_x_b").value = xv_arr[0] + "#";
                document.getElementById("my_y_b").value = yv_arr[0] + "#";
                document.getElementById("my_r_b").value = rv_arr[0] + "#";

                xv_arr.pop();
                yv_arr.pop();
                rv_arr.pop();
                var i;
                drawCoordAxis(xv_arr[0], yv_arr[0], rv_arr[0]);
                for (i=1;i < xv_arr.length-1; i++) {
                    drawCoordAxis(xv_arr[i], yv_arr[i], rv_arr[i]);
                    document.getElementById("my_x").value = document.getElementById("my_x").value + xv_arr[i] + "#";
                    document.getElementById("my_y").value = document.getElementById("my_y").value + yv_arr[i] + "#";
                    document.getElementById("my_r").value = document.getElementById("my_r").value + rv_arr[i] + "#";

                    document.getElementById("my_x_b").value = document.getElementById("my_x_b").value + xv_arr[i] + "#";
                    document.getElementById("my_y_b").value = document.getElementById("my_y_b").value + yv_arr[i] + "#";
                    document.getElementById("my_r_b").value = document.getElementById("my_r_b").value + rv_arr[i] + "#";

                }
            }
        }

   </script>
</body>
</html>